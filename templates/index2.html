<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>DocFactory</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* Basic CSS for the expandable section */
    .expander-header {
      cursor: pointer;
      background-color: #f0f0f0;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .expander-header:hover {
      background-color: #e0e0e0;
    }
    .expander-content {
      border: 1px solid #ddd;
      border-top: none;
      padding: 15px;
      border-radius: 0 0 5px 5px;
      background-color: #f9f9f9;
      /* display: none; */ /* Removed this to make it expanded by default via JS class toggle */
    }
    .expander-header::after {
      content: '‚ñº'; /* Down arrow for collapsed state */
      font-size: 1.2em;
    }
    .expander-header.expanded::after {
      content: '‚ñ≤'; /* Up arrow for expanded state */
    }
    /* Add some basic styling for list items if needed */
    .expander-content ul {
      list-style-type: disc;
      margin-left: 20px;
      padding-left: 0;
    }
    .expander-content li {
      margin-bottom: 5px;
    }

    /* Styles for the "Back to Main Menu" button */
    #backToMainMenu {
      display: none; /* Hidden initially */
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
    #backToMainMenu:hover {
      background-color: #0056b3;
    }

    /* Styles for Generated Documents section */
    #generatedDocsList {
      margin-top: 30px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }
    #generatedDocsList ul {
      list-style-type: none;
      padding: 0;
    }
    #generatedDocsList li {
      margin-bottom: 8px;
      padding: 5px 0;
      border-bottom: 1px dashed #f0f0f0;
    }
    #generatedDocsList li a {
      text-decoration: none;
      color: #007bff;
      font-weight: bold;
    }
    #generatedDocsList li a:hover {
      color: #0056b3;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>üìÑ DocFactory - Generate Documents</h1>

  <section id="howToUse">
    <div class="expander-header" id="howToUseHeader">
      <h2>‚ÑπÔ∏è How to Use This App</h2>
    </div>
    <div class="expander-content" id="howToUseContent">
      <p><b>Steps to generate a DOCX or PPTX document:</b></p>
      <ul>
        <li>Upload your <code>.docx</code> or <code>.pptx</code> template with <code>{placeholders}</code>.</li>
        <li>Enter values for key fields like <code>{CUSTOMER_NAME}</code>, <code>{CITY_NAME}</code>, <code>{SA_NAME}</code>.</li>
        <li>Upload files or type values for all other placeholders:
          <ul>
            <li><code>.docx</code>, <code>.txt</code>, <code>.pptx</code>: Extracts and inserts text</li>
            <li><code>.xlsx</code>: Inserts as Word table</li>
            <li><code>.jpg</code>, <code>.png</code>: Embedded as image (DOCX only)</li>
          </ul>
        </li>
        <li>Click <b>üõ† Generate Document</b> to build and download.</li>
      </ul>
      <p>üí° <b>Tips:</b></p>
      <ul>
        <li>If image upload fails, type a manual description instead.</li>
        <li>Keep placeholder names clean and consistent.</li>
      </ul>
    </div>
  </section>
  <section id="uploader">
    <form id="tplForm" enctype="multipart/form-data">
      <label>Select your .docx or .pptx template:</label>
      <input type="file" name="template" accept=".docx,.pptx" required>
      <button type="submit">Analyze Template</button>
    </form>
  </section>

  <section id="fields" style="display:none">
    <form id="genForm" enctype="multipart/form-data" method="POST" action="/generate">
      <div id="inputsContainer"></div>
      <button type="submit" id="generateButton">Generate Document</button>
    </form>
    <button id="backToMainMenu">Go Back to Main Menu</button>
  </section>

  <section id="generatedDocsList">
    <h2>üìÇ Recently Generated Documents</h2>
    <ul id="docsList">
      <li>Loading documents...</li>
    </ul>
  </section>
  <script>
    const KEY_FIELDS = {{ KEY_FIELDS|tojson }};
    const GENERATED_DOCS_URL = '/list_generated_files';
    const DOWNLOAD_BASE_URL = '/download/';

    // Function to fetch and display generated documents
    async function loadGeneratedDocuments() {
        const docsListElement = document.getElementById('docsList');
        docsListElement.innerHTML = '<li>Loading documents...</li>'; // Show loading state

        try {
            const response = await fetch(GENERATED_DOCS_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const filenames = await response.json();

            if (filenames.length === 0) {
                docsListElement.innerHTML = '<li>No documents generated yet.</li>';
            } else {
                docsListElement.innerHTML = ''; // Clear loading message
                filenames.forEach(filename => {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = DOWNLOAD_BASE_URL + encodeURIComponent(filename);
                    link.textContent = filename;
                    link.download = filename; // Suggests filename for download
                    listItem.appendChild(link);
                    docsListElement.appendChild(listItem);
                });
            }
        } catch (error) {
            console.error('Error loading generated documents:', error);
            docsListElement.innerHTML = '<li>Error loading documents. Please try again.</li>';
        }
    }


    // Toggle logic for "How to Use" section
    document.addEventListener('DOMContentLoaded', () => {
      const header = document.getElementById('howToUseHeader');
      const content = document.getElementById('howToUseContent');

      // Set initial state to expanded
      content.style.display = 'block';
      header.classList.add('expanded');

      header.addEventListener('click', () => {
        if (content.style.display === 'none') {
          content.style.display = 'block';
          header.classList.add('expanded');
        } else {
          content.style.display = 'none';
          header.classList.remove('expanded');
        }
      });

      // Event listener for the "Go Back to Main Menu" button
      document.getElementById('backToMainMenu').addEventListener('click', () => {
          window.location.reload(); // Reloads the page, effectively going back to initial state
      });

      // Intercept the form submission for document generation
      // to display the back button after download
      document.getElementById('genForm').addEventListener('submit', async ev => {
          ev.preventDefault(); // Prevent default form submission to handle with fetch

          const form = ev.target;
          const formData = new FormData(form); // Get form data

          // Make the fetch request to the /generate endpoint
          try {
              const res = await fetch('/generate', { method: 'POST', body: formData });
              const jsonResponse = await res.json();

              if (res.ok) {
                  alert('Document generated successfully! Check your downloads: ' + jsonResponse.filename);
                  // Refresh the list of generated documents
                  await loadGeneratedDocuments();

                  // Hide the generate section and show a message with the back button
                  document.getElementById('generateButton').style.display = 'none';
                  document.getElementById('backToMainMenu').style.display = 'block';
                  // Optionally, hide the input fields too if you want a clean view
                  document.getElementById('inputsContainer').style.display = 'none';

                  // Initiate download by creating a temporary link and clicking it
                  const downloadLink = document.createElement('a');
                  downloadLink.href = DOWNLOAD_BASE_URL + encodeURIComponent(jsonResponse.filename);
                  downloadLink.download = jsonResponse.filename; // Suggest filename for download
                  document.body.appendChild(downloadLink); // Append to body (can be invisible)
                  downloadLink.click(); // Programmatically click the link
                  document.body.removeChild(downloadLink); // Remove the link
              } else {
                  alert('Error generating document: ' + (jsonResponse.error || 'Unknown error'));
              }
          } catch (error) {
              console.error('Fetch error during generation:', error);
              alert('Network error or server unavailable during document generation.');
          }
      });

      // Load generated documents when the page loads
      loadGeneratedDocuments();
    });


    // Analyze form ‚Üí build dynamic fields (This part remains largely the same)
    document.getElementById('tplForm').addEventListener('submit', async ev => {
      ev.preventDefault();
      const form = ev.target;
      const data = new FormData(form);

      const tplFile = form.querySelector('input[name=template]').files[0];
      data.append('template', tplFile);

      try {
          const res = await fetch('/analyze', { method:'POST', body:data });
          const jsonResponse = await res.json();

          if (res.ok) {
              const { placeholders } = jsonResponse;

              document.getElementById('uploader').style.display = 'none';
              document.getElementById('fields').style.display = '';

              // Reset visibility for subsequent generations
              document.getElementById('generateButton').style.display = 'block';
              document.getElementById('backToMainMenu').style.display = 'none';
              document.getElementById('inputsContainer').style.display = 'block'; // Ensure inputs are visible

              const fileInputClone = document.createElement('input');
              fileInputClone.type = 'file';
              fileInputClone.name = 'template';

              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(tplFile);
              fileInputClone.files = dataTransfer.files;

              fileInputClone.style.display = 'none';
              document.getElementById('genForm').appendChild(fileInputClone);

              const container = document.getElementById('inputsContainer');
              container.innerHTML = '';

              placeholders.forEach(ph => {
                const div = document.createElement('div');
                div.className = 'form-group';
                const label = document.createElement('label');
                label.textContent = ph;
                div.appendChild(label);

                if (KEY_FIELDS.includes(ph)) {
                  const inp = document.createElement('input');
                  inp.type = 'text';
                  inp.name = ph;
                  if (["CUSTOMER_NAME", "PARTNER_NAME", "SA_EMAIL"].includes(ph)) {
                    inp.required = true;
                  }
                  div.appendChild(inp);
                } else {
                  const inp = document.createElement('input');
                  inp.type = 'file';
                  inp.name = ph;
                  inp.accept = 'image/*,.docx,.pptx,.xlsx,.txt';
                  div.appendChild(inp);
                }

                container.appendChild(div);
              });
          } else {
              alert('Error analyzing template: ' + (jsonResponse.error || 'Unknown error'));
              document.getElementById('uploader').style.display = '';
              document.getElementById('fields').style.display = 'none';
          }
      } catch (error) {
          console.error('Fetch error:', error);
          alert('Network error or server unavailable during template analysis. Check your browser console for details.');
          document.getElementById('uploader').style.display = '';
          document.getElementById('fields').style.display = 'none';
      }
    });
  </script>
</body>
</html>

